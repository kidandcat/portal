{{define "issues_tab"}}
<div class="tab-content">
    {{if not .IsClient}}
    <div class="toolbar">
        <button class="btn btn-primary btn-sm" onclick="document.getElementById('new-issue-modal').showModal()">Nueva tarea</button>
    </div>
    {{end}}

    <div id="issues-table-wrapper">
        {{template "issues_table" .}}
    </div>
</div>

{{if not .IsClient}}
<dialog id="new-issue-modal" class="modal">
    <form method="POST" action="/projects/{{.Project.Slug}}/issues"
          hx-post="/projects/{{.Project.Slug}}/issues"
          hx-target="#issues-table-wrapper"
          hx-on::after-request="this.closest('dialog').close(); this.reset();">
        <h2>Nueva tarea</h2>
        <div class="form-group">
            <label for="title">Título</label>
            <input type="text" id="title" name="title" required autofocus>
        </div>
        <div class="form-group">
            <label for="description">Descripción</label>
            <textarea id="description" name="description" rows="3"></textarea>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="status">Estado</label>
                <select id="status" name="status">
                    {{range .Statuses}}<option value="{{.}}">{{statusLabel .}}</option>{{end}}
                </select>
            </div>
            <div class="form-group">
                <label for="milestone_id">Hito</label>
                <select id="milestone_id" name="milestone_id">
                    <option value="">Sin hito</option>
                    {{range .Milestones}}<option value="{{.ID}}">{{.Name}}</option>{{end}}
                </select>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="this.closest('dialog').close()">Cancelar</button>
            <button type="submit" class="btn btn-primary">Crear</button>
        </div>
    </form>
</dialog>
{{end}}
{{end}}

{{define "issues_table"}}
<div class="issues-list">
    {{range .Issues}}
    {{$issue := .}}
    <div class="issue-card" data-id="{{.ID}}">
        <div class="issue-card-header">
            <span class="issue-title">{{.Title}}</span>
            {{if not $.IsClient}}
            <button class="btn btn-ghost btn-xs"
                hx-delete="/projects/{{$.Project.Slug}}/issues/{{.ID}}"
                hx-target="#issues-table-wrapper"
                hx-confirm="¿Eliminar esta tarea?">×</button>
            {{end}}
        </div>
        <div class="issue-card-meta">
            {{if not $.IsClient}}
            <select class="inline-select status-select status-{{.Status}}"
                hx-post="/projects/{{$.Project.Slug}}/issues/{{.ID}}"
                hx-target="#issues-table-wrapper"
                hx-vals='{"field":"status"}'
                name="value">
                {{range $.Statuses}}<option value="{{.}}" {{if eq . $issue.Status}}selected{{end}}>{{statusLabel .}}</option>{{end}}
            </select>
            <select class="inline-select milestone-select"
                hx-post="/projects/{{$.Project.Slug}}/issues/{{.ID}}"
                hx-target="#issues-table-wrapper"
                hx-vals='{"field":"milestone_id"}'
                name="value">
                <option value="">Sin hito</option>
                {{range $.Milestones}}<option value="{{.ID}}" {{if and $issue.MilestoneID (eq .ID (derefInt64 $issue.MilestoneID))}}selected{{end}}>{{.Name}}</option>{{end}}
            </select>
            {{else}}
            <span class="badge badge-status-{{.Status}}">{{statusLabel .Status}}</span>
            {{if .Milestone}}<span class="badge badge-milestone">{{.Milestone.Name}}</span>{{end}}
            {{end}}
        </div>
    </div>
    {{else}}
    <div class="empty-state">No hay tareas todavía</div>
    {{end}}
</div>
{{end}}
